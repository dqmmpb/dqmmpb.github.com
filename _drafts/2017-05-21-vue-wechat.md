---
layout: post
title:  "Vue在微信开发下的各种坑"
date:   2017-05-15 17:20:00 +0800
categories: jekyll update
---

## Vue在微信开发下的各种坑

不得不说，Vue带来的MVVM模式确实强大，本着试水的心态，在最近的一次微信公众号H5开发中，果断选择了Vue，结果不试不知道，一试全是坑，一言难尽啊……

### Vue的路由

由于Vue是采用路由的方式来跳转页面的，因此页面的入口只有index.html一个。路由的配置有两种方式
- hash方式
- history方式

前一种hash顾名思义，使用`#`作为路由URL的标志，根据`#`后的路径进行路由转发。而history方式则隐去`#`，已html5的history存储作为路由转发的依据。这两种方式的最明显的区别体现在路径上，hash的路径中带有`#`，而history则没有`#`。例如

- hash: http://www.emaoli.com/gifts/#/gift/wantToGive?activeCode=ZD521&goodsId=1
- history: http://www.emaoli.com/gifts/gift/wantToGive?activeCode=ZD521&goodsId=1

于是坑就来了，history方式只在支持h5的浏览器上有效，同时在android手机上的支持较差，因此只能在ios上使用。而hash则可以在ios和android中都有效。因此history方式的技术选型果断抛弃。

那是不是hash方式就没有问题了？

No！No！No！！！


#### 坑1

不要被表象所迷惑，在PC的浏览器上，hash模式显的灰常好，不会有任何问题，当然，在微信中也没发现太多问题。但最重要的坑才出现。我们知道，后台如果想获取用户的openId，是需要走微信授权的，但微信授权对url地址是有要求的，要求`#`之前的作为有效的授权地址。这还是可以接受的，因为授权还是能过的。  
但分享出去的链接就有问题了，微信会在url中添加自己的参数，于是分享后的url就有可能被微信篡改，如`http://www.emaoli.com/gifts/#/gift/wantToGive?activeCode=ZD521&goodsId=1`就被改为了`http://www.emaoli.com/gifts/?from=wechatxxx#/gift/wantToGive?activeCode=ZD521&goodsId=1`，因为微信认为`#`是作为页内元素存在的。  
可是，这样的链接仍能正常路由到对应的页面，其实表现层看起来是没啥问题的，但关键的问题**如果该页面在进行分享的话**链接就跪了，导致分享的验签是不成功的。


#### 坑2

hash的`#`带来的问题不仅仅出现在二次分享中，还出现在调用微信支付的场景中，微信支付对url的要求是全url验签，因此直接导致了签名错误，解决方法就是针对`#`的url，使用`?#`替换调`#`，迷惑微信将`#`和后面的路由看做参数对待，因此签名能够通过。但这也直接导致了坑1的各种不确定性。同时，如果页内包含`<router-link>`方式的跳转，会导致`<router-link>`跳转后的地址，是以`?#`作为初始url的，导致了原页面通过query方式去获取页面参数的不正常。对于这种情况的处理，只能暴力的通过location.href方式，放弃`<router-link>`。


以上2个坑都花了很久才解决，一方面是vue结合微信的资料比较少，虽然有一篇文章详细描述了上述2个坑，但解决方案也不完美。对于`#`问题，微信方面也有一些描述，但短时间内，估计微信也不打算支持，毕竟是强者。


#### 坑3

坑3实际上不是微信的坑，而且项目中引入了网易七鱼云客服平台导致的，平台的js代码在PC上是正常的，在微信中则变得不正常了，原因是七鱼的js在console中会报错，而这个错误在PC等浏览器中被无视了，而微信中却没有无视它，直接后果就是跟随的wx.config无法生效，导致分享链接无法点击。最终的解决方案是，使用中间页面作为跳转，该页面不做微信分享配置，直接调起七鱼的页面。这样的后果就是，七鱼提供的业内显示`联系客服`的层要自己维护了，但相对于不能够分享，这个方案显然还是能接受的

